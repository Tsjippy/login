(()=>{"use strict";const e=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},t=e=>btoa(String.fromCharCode(...e)),n=t=>(t.challenge=Uint8Array.from(e(t.challenge),(e=>e.charCodeAt(0))),void 0!==t.user&&(t.user={...t.user,id:Uint8Array.from(window.atob(t.user.id),(e=>e.charCodeAt(0)))}),void 0!==t.excludeCredentials&&(t.excludeCredentials=t.excludeCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),void 0!==t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),t),s=e=>{const n={id:e.id,type:e.type,rawId:t(new Uint8Array(e.rawId)),response:{clientDataJSON:t(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(n.response.attestationObject=t(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(n.response.authenticatorData=t(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(n.response.signature=t(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(n.response.userHandle=t(new Uint8Array(e.response.userHandle))),n};function r(e,t=""){let n=document.querySelector("#message");n.innerHTML=DOMPurify.sanitize(e),n.classList.remove("success"),n.classList.remove("warning"),n.classList.remove("error"),"success"==t&&n.classList.add("success"),"warning"==t&&n.classList.add("warning"),"error"==t&&n.classList.add("error")}let i,o=5;async function a(){o++;let e=new FormData,t=document.getElementById("qrcode-wrapper"),n=document.getElementById("login-qr-code");if(6==o){console.log("Refreshing QR code"),o=0,null!=n&&(e.append("token",n.dataset.token),e.append("key",n.dataset.key));let s=await FormSubmit.fetchRestApi("login/get_login_qr_code",e);s?(t.innerHTML=s,r("Scan the QR code to login"),console.log(`New token: ${document.getElementById("login-qr-code").dataset.token}`),console.log(`New key: ${document.getElementById("login-qr-code").dataset.key}`)):(wrapperinnerHTML="",r("QR Code Refresh Failed","error"))}else{if(console.log("Checking for login permission"),null==n)return;e.append("token",n.dataset.token),e.append("key",n.dataset.key),e.append("old-token",n.dataset.oldtoken);let t=await FormSubmit.fetchRestApi("login/qr_code_scanned",e);t&&function(e){clearInterval(i),r("Succesfully logged in, redirecting...","success"),Main.showLoader(document.getElementById("qrcode-wrapper")),e.startsWith("http")?location.href=e:location.reload()}(t)}}let l,d=!1;window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e||console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.")}));let c=async e=>{if(window.PublicKeyCredential&&PublicKeyCredential.isConditionalMediationAvailable){if(console.log("Conditional UI is understood by the browser"),!await window.PublicKeyCredential.isConditionalMediationAvailable())return void console.log("Conditional UI is understood by your browser but not available")}else{if(!navigator.credentials.conditionalMediationSupported)return void console.log("Your browser does not implement Conditional UI (are you running the right chrome/safari version with the right flags?)");console.log("This browser understand the old version of Conditional UI feature detection")}null!=l&&(console.log("Cancelling previous request"),l.abort("aborted")),l=new AbortController,l.onAbort=function(e){console.log(e)},l.signal.onAbort=function(e){console.log(e)},"conditional"!=e&&sim.login.loadingScreen("Performing passkey login");try{let t=new FormData;t.append("username","");let i=await FormSubmit.fetchRestApi("login/auth_start",t);if(!i)throw new Error("auth_start failed");let o=n(i),a=await navigator.credentials.get({signal:l.signal,publicKey:{challenge:o.challenge},mediation:e});return"conditional"==e&&sim.login.loadingScreen("Performing passkey login"),await async function(e){if(!d){if(e){d=!0,sim.login.loadingScreen("Verifying credentials...");const t=s(e);let n=new FormData(document.getElementById("loginform"));return n.append("publicKeyCredential",JSON.stringify(t)),await FormSubmit.fetchRestApi("login/auth_finish",n,!1)?(r("Passkey login succesfull","success"),await sim.login.requestLogin()):(sim.login.reset(),r("Passkey login failed, try using your username and password","error"),!1)}return console.log("Credential returned null"),sim.login.resetForm(),r("Passkey login failed","error"),!1}}(a)}catch(t){return"aborted"==t?(console.log("request aborted"),!1):(t.message.includes("A request is already pending.")&&c(e),null!=sim.login&&(sim.login.resetForm(),r("Passkey login failed, try using your username and password","error")),console.log(t),!1)}};async function u(){let e=!1;return window.PublicKeyCredential?await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()?e=!0:console.log("WebAuthn supported, Platform Authenticator not supported."):console.log("Not supported."),e}console.log("Login.js loaded");const m=class{constructor(){this.init(),null!=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)}).showlogin&&(console.log("Trying silent login"),c("silent")),this.checkIsIOS&&this.addMaximumScaleToMetaViewport(),this.eventListeners()}eventListeners(){document.addEventListener("keypress",(e=>{"Enter"===e.key&&null!=this.creds&&(this.curScreen==this.creds&&0==document.getElementById("check-cred").disabled?this.verifyCreds():this.curScreen!=this.email&&this.curScreen!=this.twofa||this.requestLogin())})),document.addEventListener("click",(async e=>{let t=e.target;t.matches(".login")?(this.openLoginModal(),console.log("Trying silent login")):"check-cred"==t.id?this.verifyCreds():"login-button"==t.id?this.requestLogin():null!=t.closest(".toggle-pwd-view")?h(e):"password-reset-form"==t.id||"lost-pwd-link"==t.id?this.resetPassword(t):"retry_webauthn"==t.id?(this.showMessage(""),this.verifyWebauthn([])):"request_account"==t.name?this.requestAccount(t):null!=t.closest("[name='fingerprintpicture']")?c("silent"):t.matches(".show-login-qr")?(document.getElementById("usercred-wrapper").classList.add("hidden"),r("Fetching QR code..."),Main.showLoader(document.getElementById("qrcode-wrapper").firstChild),a(),i=setInterval(a,5e3)):t.matches(".close-qr")&&(clearInterval(i),r(""),document.getElementById("usercred-wrapper").classList.remove("hidden"),document.getElementById("qrcode-wrapper").innerHTML="")}))}checkIsIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}init(){this.form=document.getElementById("loginform"),this.msgScreen=document.getElementById("message-wrapper"),this.creds=document.getElementById("credentials-wrapper"),this.twofa=document.getElementById("authenticator-wrapper"),this.email=document.getElementById("email-wrapper"),this.login=document.getElementById("login-button-wrapper"),this.passwordReset=document.getElementById("password-reset-form"),this.curScreen=this.creds}resetForm(){null==this.msgScreen.querySelector(".loader")&&Main.showLoader(this.msgScreen.querySelector(".status-message"),!1,75),this.reset(),this.showScreen(this.creds),this.curScreen=this.creds}loadingScreen(e){this.msgScreen.querySelector(".status-message").textContent=e,this.curScreen.classList.add("hidden"),this.login.classList.add("hidden"),this.passwordReset.classList.add("hidden"),this.msgScreen.classList.remove("hidden")}reset(){null!=this.curScreen&&(this.curScreen.classList.remove("hidden"),this.msgScreen.classList.add("hidden"),this.passwordReset.classList.remove("hidden"))}showScreen(e){null!=this.curScreen&&(this.curScreen.classList.add("hidden"),this.msgScreen.classList.add("hidden")),e.classList.remove("hidden"),e==this.twofa||e==this.email?this.login.classList.remove("hidden"):this.login.classList.add("hidden"),e.querySelectorAll("input").forEach((e=>window.setTimeout((()=>e.focus()),0))),this.curScreen=e,r("")}async verifyCreds(){this.username=document.getElementById("username").value;let e=document.getElementById("password").value;if(""==this.username||""==e)return void r("Please give an username and password!","warning");this.passwordReset.classList.add("hidden"),this.loadingScreen("Verifying Credentials"),await Main.waitForInternet();let t=new FormData(this.form),n=await FormSubmit.fetchRestApi("login/check-cred",t);n?(n="false"!=n&&0!=n&&this.addMethods(n),n||(this.reset(),r("Invalid login, try again","error"))):this.reset()}addMethods(e){return"object"!=typeof e&&location.reload(),"redirect"in e?(location.href=e.redirect,!0):e instanceof Array?(e.find((e=>"webauthn"==e))?u()?this.verifyWebauthn(e):1==e.length?(r("You do not have a valid second login method for this device, please add one.","warning"),this.requestLogin()):this.showTwoFaFields(e):this.showTwoFaFields(e),!0):void 0}async verifyWebauthn(e){this.loadingScreen("Starting Webauthentication");try{if(!await async function(e,t=null){null!=t&&(t.classList.remove("success"),t.classList.remove("error"));try{let r=new FormData;r.append("username",e);let i=await FormSubmit.fetchRestApi("login/auth_start",r);if(!i)throw new Error("Fetching Server Challenge failed");let o=n(i);null!=t&&(t.textContent="Waiting for biometric");let a=await navigator.credentials.get({publicKey:o});null!=t&&(t.textContent="Verifying...");const l=s(a);let d=document.getElementById("loginform")?document.getElementById("loginform"):void 0;if(r=new FormData(d),r.append("publicKeyCredential",JSON.stringify(l)),i=await FormSubmit.fetchRestApi("login/auth_finish",r),!i)throw new Error("Verification failed");return null!=t?(t.textContent="Verification successfull",t.classList.add("success")):Main.displayMessage("Verification successfull"),!0}catch(e){return console.error(e),null!=t?(t.textContent=e,t.classList.add("error")):Main.displayMessage(e,"error"),!1}}(this.username,this.msgScreen.querySelector(".status-message")))throw new Error("Webauthentication failed");await this.requestLogin()}catch(t){let n=await FormSubmit.fetchRestApi("login/mark_bio_as_failed","",!1);if(console.log(n),1==e.length)r("Authentication failed, please setup an additional login factor.","error"),this.requestLogin();else{let n;console.error(t),n="No authenticator available"==t.message?"No biometric login for this device found. <br>Give verification code.":"Web authentication failed, please give verification code.",r(n,"error"),this.showTwoFaFields(e)}}}async requestLogin(){this.loadingScreen("Logging in...");let e=new FormData(this.form);if(this.form.querySelectorAll(".hidden [required]").forEach((e=>{e.required=!1})),!this.form.reportValidity())return this.reset(),!1;await Main.waitForInternet();let t=await FormSubmit.fetchRestApi("login/request_login",e);return t?(console.log(t),window.self!==window.top?(console.log(window.parent.document.getElementById("iframe-loader")),console.log(window.parent.document),console.log(window.parent),window.parent.document.getElementById("iframe-loader").textContent="Succesfully logged in, you may now close this popup",window.parent.sim.restNonce=t.nonce,window.parent.sim.userId=t.id,console.log(window.parent.document.getElementById("iframe-loader")),window.parent.document.querySelectorAll("iframe").forEach((e=>e.remove()))):(this.loadingScreen("Succesfully logged in, redirecting..."),""==t.redirect?location.reload():location.href=t.redirect),!0):(this.reset(),!1)}showTwoFaFields(e){e.includes("email")&&this.requestEmailCode();for(const t of e)"webauthn"!=t&&("email"==t?this.showScreen(this.email):this.showScreen(this.twofa))}async requestEmailCode(){this.showScreen(this.email),r(`Sending e-mail... ${Main.showLoader(null,!1,20,"",!0)}`);let e=new FormData;e.append("username",this.username);let t=await FormSubmit.fetchRestApi("login/request_email_code",e,!1);t?r(t):r("Sending e-mail failed","error")}async resetPassword(e){let t=e.closest("form"),n=t.querySelector("#lost-pwd-link"),s=t.querySelector("div.form-elements");if(null!=s&&""!=s.innerHTML&&s.classList.contains("hidden"))return document.getElementById("loginform").classList.add("hidden"),null==t.querySelector("[name='username']")&&(s.innerHTML=`<label class="form-label">\n\t\t\t\t\tUsername<br>\n\t\t\t\t\t<input type="text" name="username" id="username" class="form-control" value="${this.username}" required>\n\t\t\t\t</label><br>`+s.innerHTML),s.classList.remove("hidden"),n.dataset.orghtml=n.innerHTML,n.innerHTML="Request Password Reset",void n.classList.add("button");if(""==this.username)return void Main.displayMessage("Specify your username first","error");n.classList.add("hidden");let r=Main.showLoader(n,!1,50,"Requesting Password Reset...   "),i=new FormData(t);i.append("username",this.username);let o=await FormSubmit.fetchRestApi("login/request_pwd_reset",i);o&&(Main.displayMessage(o,"success"),document.getElementById("loginform").classList.remove("hidden"),s.classList.add("hidden"),n.innerHTML=n.dataset.orghtml,n.classList.remove("button")),r.remove(),n.classList.remove("hidden")}async requestAccount(e){let t=e.closest("form");t.querySelector(".loader-wrapper").classList.remove("hidden");let n=new FormData(t),s=await FormSubmit.fetchRestApi("login/request_user_account",n);s&&Main.displayMessage(s),t.reset(),t.querySelector(".loader-wrapper").classList.add("hidden")}openLoginModal(){document.querySelectorAll("#site-navigation, #mobile-menu-control-wrapper").forEach((e=>e.classList.remove("toggled"))),document.querySelector("body").classList.remove("mobile-menu-open"),document.querySelectorAll("#mobile-menu-control-wrapper > button").forEach((e=>e.ariaExpanded="false")),document.querySelector("body").style.overflowY="hidden",this.modal=document.getElementById("login-modal"),this.modal.style.display="block",this.modal.classList.remove("hidden"),this.resetForm()}addMaximumScaleToMetaViewport(){let e=document.querySelector("meta[name=viewport]");if(null!==e){let t=e.getAttribute("content"),n=/maximum\-scale=[0-9\.]+/g;t=n.test(t)?t.replace(n,"maximum-scale=1.0"):[t,"maximum-scale=1.0"].join(", "),e.setAttribute("content",t)}}};function h(e){var t=e.target;"IMG"==e.target.tagName&&(t=e.target.parentNode),"0"==t.dataset.toggle?(t.title="Hide password",t.dataset.toggle="1",t.innerHTML=t.innerHTML.replace("invisible","visible"),t.closest(".password").querySelector('input[type="password"]').type="text"):(t.title="Show password",t.dataset.toggle="0",t.innerHTML=t.innerHTML.replace("visible","invisible"),t.closest(".password").querySelector('input[type="text"]').type="password")}function g(){var e=document.querySelector('[name="pass1"]'),t=document.querySelector('[name="pass2"]'),n=document.querySelector("#pass-strength-result1"),s=document.querySelector("#pass-strength-result2"),r="Strength indicator";""==e.value?(n.textContent=r,n.classList.add("hidden")):p(n),""==t.value?(s.textContent=r,s.classList.add("hidden")):(p(s),""!=e.value&&n.classList.add("hidden"))}function p(e){e.classList.remove("short","bad","good","strong");var t=document.querySelector('[name="pass1"]'),n=document.querySelector('[name="pass2"]');if(t.value!=n.value)e.classList.add("bad"),e.textContent=pwsL10n.mismatch;else switch(wp.passwordStrength.meter(t.value,wp.passwordStrength.userInputDisallowedList(),n.value)){case 2:e.classList.add("bad"),e.textContent=pwsL10n.bad;break;case 3:e.classList.add("good"),e.textContent=pwsL10n.good;break;case 4:e.classList.add("strong"),e.textContent=pwsL10n.strong;break;case 5:e.classList.add("short"),e.textContent=pwsL10n.mismatch;break;default:e.classList.add("short"),e.textContent=pwsL10n.short}e.classList.remove("hidden")}async function w(e){var t=e.target.closest("form");t.querySelector(".submit-wrapper .loader-wrapper").classList.remove("hidden");var n=new FormData(t),s=await FormSubmit.fetchRestApi("login/update_password",n);s&&(Main.displayMessage(s.message),location.href.includes("?user-id=")||(location.href=s.redirect)),t.querySelector(".submit-wrapper .loader-wrapper").classList.add("hidden")}document.addEventListener("DOMContentLoaded",(()=>{u(),document.querySelectorAll(".login.hidden").forEach((e=>{e.classList.remove("hidden")})),sim.login=new m})),console.log("Password strength.js loaded"),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".changepass").forEach((e=>e.addEventListener("keyup",g))),document.querySelectorAll('[name="update-password"]').forEach((e=>e.addEventListener("click",w))),document.querySelectorAll(".toggle-pwd-view").forEach((e=>e.addEventListener("click",h)))}))})();
//# sourceMappingURL=password_strength.min.js.map