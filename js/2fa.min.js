(()=>{"use strict";const e=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},t=e=>btoa(String.fromCharCode(...e));let r=!1;window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e||console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.")})),console.log("2fa.js loaded"),document.addEventListener("DOMContentLoaded",(function(){null!=document.querySelector("#webauthn_wrapper.hidden")&&(window.PublicKeyCredential?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e?(console.log("Supported."),r=!0):console.log("WebAuthn supported, Platform Authenticator not supported.")})).catch((e=>{console.error("Something went wrong."),console.error(e)})):console.log("Not supported."))})),document.addEventListener("click",(r=>{var a=r.target;"2fa_methods[]"==a.name&&function(e){document.querySelectorAll(".twofa_option").forEach((e=>e.classList.add("hidden")));var t=document.getElementById("setup-"+e.value);t.classList.remove("hidden"),Main.isMobileDevice()?t.querySelectorAll(".mobile.hidden").forEach((e=>e.classList.remove("hidden"))):t.querySelectorAll(".desktop.hidden").forEach((e=>e.classList.remove("hidden"))),"authenticator"==e.value&&e.closest("form").querySelector(".form_submit").classList.remove("hidden")}(a),a.matches(".remove_webauthn")&&async function(e){let t=e.closest("table"),r=e.closest("tr"),a=new FormData;a.append("key",e.dataset.key),Main.showLoader(e,!0);let n=await FormSubmit.fetchRestApi("login/remove_web_authenticator",a);n&&(2==t.rows.length?t.remove():r.remove(),Main.displayMessage(n))}(a),"add_fingerprint"==a.id&&async function(r){let a=r.closest("#webauthn_wrapper").querySelector('[name="identifier"]').value;if(""==a)return void Main.displayMessage("Please specify a device name","error");document.getElementById("add_webauthn").classList.add("hidden");let n=`<div id="loader_wrapper" style='margin-bottom:20px;'><span class="message"></span><img class="loadergif" src="${sim.loadingGif}" height="30px;"></div>`;document.getElementById("add_webauthn").insertAdjacentHTML("afterEnd",n);let i=document.querySelector("#loader_wrapper .message");try{let r=new FormData;r.append("identifier",a);let n=await FormSubmit.fetchRestApi("login/fingerprint_options",r);if(!n)throw new Error("Options retrieval failed");let d=(t=>(t.challenge=Uint8Array.from(e(t.challenge),(e=>e.charCodeAt(0))),void 0!==t.user&&(t.user={...t.user,id:Uint8Array.from(window.atob(t.user.id),(e=>e.charCodeAt(0)))}),void 0!==t.excludeCredentials&&(t.excludeCredentials=t.excludeCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),void 0!==t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),t))(n);i.textContent="Please authenticate...";let l=await navigator.credentials.create({publicKey:d});i.textContent="Saving authenticator...";var o=(e=>{const r={id:e.id,type:e.type,rawId:t(new Uint8Array(e.rawId)),response:{clientDataJSON:t(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(r.response.attestationObject=t(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(r.response.authenticatorData=t(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(r.response.signature=t(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(r.response.userHandle=t(new Uint8Array(e.response.userHandle))),r})(l);if(r=new FormData,r.append("publicKeyCredential",JSON.stringify(o)),n=await FormSubmit.fetchRestApi("login/store_fingerprint",r),!n)throw new Error("Storing biometric failed");var s=document.getElementById("webautn_devices_wrapper");null==s?document.getElementById("webauthn_wrapper").insertAdjacentHTML("beforeEnd",n):s.outerHTML=n,SimTableFunctions.setTableLabel(),Main.displayMessage("Registration success")}catch(e){document.getElementById("add_webauthn").classList.remove("hidden"),console.error(e),Main.displayMessage(e,"error")}document.querySelector("#loader_wrapper").remove()}(a),"save2fa"==a.name&&async function(e){let t=e.closest(".submit_wrapper").querySelector(".loadergif");t.classList.remove("hidden");let r=e.closest("form");if(r.querySelectorAll(".hidden [required], select[required]").forEach((e=>{e.required=!1})),r.reportValidity()){let t=new FormData(r),a=await FormSubmit.fetchRestApi("login/save_2fa_settings",t);a&&(r.querySelectorAll('[id^="setup-"]:not(.hidden)').forEach((e=>e.classList.add("hidden"))),Main.displayMessage(a,"success"),e.closest("form").querySelector(".form_submit").classList.add("hidden"))}t.classList.add("hidden")}(a),"email-code-button"==a.id&&async function(e){var t=`<img id='loader' src='${sim.loadingGif}' style='height:30px;margin-top:-6px;float:right;'>`;document.getElementById("email-message").innerHTML=`Sending e-mail... ${t}`;var r=document.getElementById("username").value,a=new FormData;a.append("username",r);var n=await FormSubmit.fetchRestApi("login/request_email_code",a);n&&(document.getElementById("email-message").innerHTML=n,document.getElementById("email-message").classList.add("success"),document.getElementById("email-code-validation").classList.remove("hidden"),e.classList.add("hidden"),e.closest("form").querySelector(".form_submit").classList.remove("hidden"),document.getElementById("email-code-validation").focus())}(a)}))})();
//# sourceMappingURL=2fa.min.js.map