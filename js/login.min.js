(()=>{"use strict";const e=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},t=e=>btoa(String.fromCharCode(...e)),n=t=>(t.challenge=Uint8Array.from(e(t.challenge),(e=>e.charCodeAt(0))),void 0!==t.user&&(t.user={...t.user,id:Uint8Array.from(window.atob(t.user.id),(e=>e.charCodeAt(0)))}),void 0!==t.excludeCredentials&&(t.excludeCredentials=t.excludeCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),void 0!==t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),t),r=e=>{const n={id:e.id,type:e.type,rawId:t(new Uint8Array(e.rawId)),response:{clientDataJSON:t(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(n.response.attestationObject=t(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(n.response.authenticatorData=t(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(n.response.signature=t(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(n.response.userHandle=t(new Uint8Array(e.response.userHandle))),n};function o(e,t=""){let n=document.querySelector("#message");n.innerHTML=DOMPurify.sanitize(e),n.classList.remove("success"),n.classList.remove("warning"),n.classList.remove("error"),"success"==t&&n.classList.add("success"),"warning"==t&&n.classList.add("warning"),"error"==t&&n.classList.add("error")}async function a(){document.querySelectorAll(".authenticator_wrapper:not(.hidden)").forEach((e=>{e.classList.add("hidden"),e.classList.add("current-method")})),document.getElementById("logging_in_wrapper").classList.remove("hidden");let e=document.getElementById("loginform"),t=new FormData(e);if(e.querySelectorAll(".hidden [required]").forEach((e=>{e.required=!1})),!e.reportValidity())return!1;await Main.waitForInternet();let n=await FormSubmit.fetchRestApi("login/request_login",t);return n?(console.log(n),window.self!==window.top?(console.log(window.parent.document.getElementById("iframe-loader")),console.log(window.parent.document),console.log(window.parent),window.parent.document.getElementById("iframe-loader").textContent="Succesfully logged in, you may now close this popup",window.parent.sim.restNonce=n.nonce,window.parent.sim.userId=n.id,console.log(window.parent.document.getElementById("iframe-loader")),window.parent.document.querySelectorAll("iframe").forEach((e=>e.remove()))):(document.querySelector("#logging_in_wrapper .status_message").textContent="Succesfully logged in, redirecting...",""==n.redirect?location.reload():location.href=n.redirect),!0):(document.getElementById("logging_in_wrapper").classList.add("hidden"),document.querySelector(".current-method").classList.remove("hidden"),!1)}let i,s=5;async function l(){s++;let e=new FormData,t=document.getElementById("qrcode-wrapper"),n=document.getElementById("login-qr-code");if(6==s){console.log("Refreshing QR code"),s=0,null!=n&&(e.append("token",n.dataset.token),e.append("key",n.dataset.key));let r=await FormSubmit.fetchRestApi("login/get_login_qr_code",e);r?(t.innerHTML=r,o("Scan the QR code to login"),console.log(`New token: ${document.getElementById("login-qr-code").dataset.token}`),console.log(`New key: ${document.getElementById("login-qr-code").dataset.key}`)):(wrapperinnerHTML="",o("QR Code Refresh Failed","error"))}else{if(console.log("Checking for login permission"),null==n)return;e.append("token",n.dataset.token),e.append("key",n.dataset.key),e.append("old-token",n.dataset.oldtoken);let t=await FormSubmit.fetchRestApi("login/qr_code_scanned",e);t&&function(e){clearInterval(i),o("Succesfully logged in, redirecting...","success"),Main.showLoader(document.getElementById("qrcode-wrapper")),e.startsWith("http")?location.href=e:location.reload()}(t)}}let d,c=!1;async function u(e){document.getElementById("webauthn_wrapper").classList.remove("hidden");let t=document.getElementById("username").value;try{let e=await async function(e,t=null){null!=t&&(t.classList.remove("success"),t.classList.remove("error"));try{let o=new FormData;o.append("username",e);let a=await FormSubmit.fetchRestApi("login/auth_start",o);if(!a)throw new Error("Fetching Server Challenge failed");let i=n(a);null!=t&&(t.textContent="Waiting for biometric");let s=await navigator.credentials.get({publicKey:i});null!=t&&(t.textContent="Verifying...");const l=r(s);let d=document.getElementById("loginform")?document.getElementById("loginform"):void 0;if(o=new FormData(d),o.append("publicKeyCredential",JSON.stringify(l)),a=await FormSubmit.fetchRestApi("login/auth_finish",o),!a)throw new Error("Verification failed");return null!=t?(t.textContent="Verification successfull",t.classList.add("success")):Main.displayMessage("Verification successfull"),!0}catch(e){return console.error(e),null!=t?(t.textContent=e,t.classList.add("error")):Main.displayMessage(e,"error"),!1}}(t,document.querySelector("#webauthn_wrapper .status_message"));if(!e)throw new Error("Webauthentication failed");await a()}catch(t){document.getElementById("logging_in_wrapper").classList.add("hidden"),document.querySelector("#webauthn_wrapper").classList.add("hidden");let n=await FormSubmit.fetchRestApi("login/mark_bio_as_failed","",!1);console.log(n),1==e.length?(o("Authentication failed, please setup an additional login factor.","error"),a()):(console.error(t),o("No authenticator available"==t.message?"No biometric login for this device found. <br>Give verification code.":"Web authentication failed, please give verification code.","error"),w(e))}}window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e||console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.")}));let m,g=async e=>{if(window.PublicKeyCredential&&PublicKeyCredential.isConditionalMediationAvailable){if(console.log("Conditional UI is understood by the browser"),!await window.PublicKeyCredential.isConditionalMediationAvailable())return void console.log("Conditional UI is understood by your browser but not available")}else{if(!navigator.credentials.conditionalMediationSupported)return void console.log("Your browser does not implement Conditional UI (are you running the right chrome/safari version with the right flags?)");console.log("This browser understand the old version of Conditional UI feature detection")}null!=d&&(console.log("Cancelling previous request"),d.abort("aborted")),d=new AbortController,d.onAbort=function(e){console.log(e)},d.signal.onAbort=function(e){console.log(e)},"conditional"!=e&&(document.getElementById("usercred_wrapper").classList.add("hidden"),document.getElementById("webauthn_wrapper").classList.remove("hidden"),o("Performing passkey login"));let t=document.getElementById("usercred_wrapper");try{let i=new FormData;i.append("username","");let s=await FormSubmit.fetchRestApi("login/auth_start",i);if(!s)throw new Error("auth_start failed");let l=n(s),u=await navigator.credentials.get({signal:d.signal,publicKey:{challenge:l.challenge},mediation:e});return"conditional"==e&&(t.classList.add("hidden"),document.getElementById("webauthn_wrapper").classList.remove("hidden"),o("Performing passkey login")),await async function(e){if(!c){if(e){c=!0,String.fromCodePoint(...new Uint8Array(e.response.userHandle)),document.querySelector("#webauthn_wrapper .status_message").textContent="Verifying credentials...";const t=r(e);let n=new FormData(document.getElementById("loginform"));return n.append("publicKeyCredential",JSON.stringify(t)),await FormSubmit.fetchRestApi("login/auth_finish",n,!1)?(o("Passkey login succesfull","success"),await a()):(document.querySelector("#webauthn_wrapper .status_message").textContent="Please authenticate",document.querySelectorAll("#usercred_wrapper").forEach((e=>e.classList.remove("hidden"))),document.querySelectorAll("#webauthn_wrapper").forEach((e=>e.classList.add("hidden"))),o("Passkey login failed, try using your username and password","error"),!1)}return console.log("Credential returned null"),document.getElementById("usercred_wrapper").classList.remove("hidden"),document.getElementById("webauthn_wrapper").classList.add("hidden"),o("Passkey login failed","error"),!1}}(u)}catch(n){return"aborted"==n?(console.log("request aborted"),!1):(n.message.includes("A request is already pending.")&&g(e),null!=t&&(t.classList.remove("hidden"),document.getElementById("webauthn_wrapper").classList.add("hidden"),o("Passkey login failed, try using your username and password","error")),console.log(n),!1)}};async function p(){let e=!1;return window.PublicKeyCredential?await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()?e=!0:console.log("WebAuthn supported, Platform Authenticator not supported."):console.log("Not supported."),e}function w(e){e.includes("email")&&async function(){o(`Sending e-mail... ${Main.showLoader(null,!1,50,"",!0)}`);let e=document.getElementById("username").value,t=new FormData;t.append("username",e);let n=await FormSubmit.fetchRestApi("login/request_email_code",t,!1);n?o(n,"success"):o("Sending e-mail failed","error")}();for(const n of e)if("webauthn"!=n){var t=document.getElementById(n+"_wrapper");null!=t&&(t.classList.remove("hidden"),t.querySelectorAll("input").forEach((e=>window.setTimeout((()=>e.focus()),0))))}document.querySelector("#login_button").disabled="",document.querySelector("#submit_login_wrapper").classList.remove("hidden")}async function y(){var e=document.getElementById("username").value,t=document.getElementById("password").value;if(""==e||""==t)return void o("Please give an username and password!","warning");document.querySelector("#usercred_wrapper .loader_wrapper").classList.remove("hidden"),await Main.waitForInternet();let n=new FormData(document.getElementById("loginform")),r=await FormSubmit.fetchRestApi("login/check_cred",n);r&&("false"==r?(o("Invalid login, try again","error"),document.querySelector("#usercred_wrapper .loader_wrapper").classList.add("hidden")):function(e){if(document.querySelector("#usercred_wrapper .loader_wrapper").classList.add("hidden"),e)if("object"==typeof e){if("redirect"in e)return void(location.href=e.redirect);e instanceof Array&&(document.querySelectorAll("#usercred_wrapper").forEach((e=>e.classList.add("hidden"))),o(""),e.find((e=>"webauthn"==e))?p()?u(e):1==e.length?(o("You do not have a valid second login method for this device, please add one.","warning"),a()):w(e):w(e))}else location.reload();else o("Invalid username or password!","error")}(r))}function h(){document.querySelectorAll("#site-navigation, #mobile-menu-control-wrapper").forEach((e=>e.classList.remove("toggled"))),document.querySelector("body").classList.remove("mobile-menu-open"),document.querySelectorAll("#mobile-menu-control-wrapper > button").forEach((e=>e.ariaExpanded="false")),document.querySelector("body").style.overflowY="hidden",m=document.getElementById("login_modal"),m.style.display="block",m.querySelectorAll(".authenticator_wrapper:not(.hidden)").forEach((e=>e.classList.add("hidden"))),m.querySelector("#usercred_wrapper").classList.remove("hidden"),m.classList.remove("hidden"),window.setTimeout((()=>m.querySelector("#username").focus()),0)}console.log("Login.js loaded"),document.addEventListener("keypress",(function(e){"Enter"===e.key&&null!=document.querySelector("#usercred_wrapper")&&(document.querySelector("#usercred_wrapper").classList.contains("hidden")||null==document.getElementById("check_cred")||0!=document.getElementById("check_cred").disabled?document.querySelector("#submit_login_wrapper").classList.contains("hidden")||a():y())})),document.addEventListener("DOMContentLoaded",(()=>{p(),document.querySelectorAll(".login.hidden").forEach((e=>{e.classList.remove("hidden")}))})),document.addEventListener("click",(async function(e){var t=e.target;t.matches(".login")?(h(),console.log("Trying silent login"),h()):"check_cred"==t.id?y():"login_button"==t.id?a():null!=t.closest(".toggle_pwd_view")?function(e){var t=e.target;"IMG"==e.target.tagName&&(t=e.target.parentNode),"0"==t.dataset.toggle?(t.title="Hide password",t.dataset.toggle="1",t.innerHTML=t.innerHTML.replace("invisible","visible"),t.closest(".password").querySelector('input[type="password"]').type="text"):(t.title="Show password",t.dataset.toggle="0",t.innerHTML=t.innerHTML.replace("visible","invisible"),t.closest(".password").querySelector('input[type="text"]').type="password")}(e):"password-reset-form"==t.id||"lost_pwd_link"==t.id?async function(e){let t=document.getElementById("username").value,n=e.closest("form"),r=n.querySelector("#lost_pwd_link"),o=n.querySelector("div.form-elements");if(null!=o&&""!=o.innerHTML&&o.classList.contains("hidden"))return document.getElementById("loginform").classList.add("hidden"),null==n.querySelector("[name='username']")&&(o.innerHTML=`<label class="form-label">\n\t\t\t\tUsername<br>\n\t\t\t\t<input type="text" name="username" id="username" class="form-control" value="${t}" required>\n\t\t\t</label><br>`+o.innerHTML),o.classList.remove("hidden"),r.dataset.orghtml=r.innerHTML,r.innerHTML="Request Password Reset",void r.classList.add("button");if(null!=n.querySelector("[name='username']")&&(t=n.querySelector("[name='username']").value),""==t)return void Main.displayMessage("Specify your username first","error");r.classList.add("hidden");let a=Main.showLoader(r,!1,50,"Requesting Password Reset...   "),i=new FormData(n);i.append("username",t);let s=await FormSubmit.fetchRestApi("login/request_pwd_reset",i);s&&(Main.displayMessage(s,"success"),document.getElementById("loginform").classList.remove("hidden"),o.classList.add("hidden"),r.innerHTML=r.dataset.orghtml,r.classList.remove("button")),a.remove(),r.classList.remove("hidden")}(t):"retry_webauthn"==t.id?(o(""),u([])):"request_account"==t.name?async function(e){let t=e.closest("form");t.querySelector(".loader_wrapper").classList.remove("hidden");let n=new FormData(t),r=await FormSubmit.fetchRestApi("login/request_user_account",n);r&&Main.displayMessage(r),t.reset(),t.querySelector(".loader_wrapper").classList.add("hidden")}(t):null!=t.closest("[name='fingerprintpicture']")?g("silent"):t.matches(".show-login-qr")?(document.getElementById("usercred_wrapper").classList.add("hidden"),o("Fetching QR code..."),Main.showLoader(document.getElementById("qrcode-wrapper").firstChild),l(),i=setInterval(l,5e3)):t.matches(".close-qr")&&(clearInterval(i),o(""),document.getElementById("usercred_wrapper").classList.remove("hidden"),document.getElementById("qrcode-wrapper").innerHTML="")})),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(()=>{const e=document.querySelector("meta[name=viewport]");if(null!==e){let t=e.getAttribute("content"),n=/maximum\-scale=[0-9\.]+/g;t=n.test(t)?t.replace(n,"maximum-scale=1.0"):[t,"maximum-scale=1.0"].join(", "),e.setAttribute("content",t)}})(),null!=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)}).showlogin&&(console.log("Trying silent login"),g("silent"))})();
//# sourceMappingURL=login.min.js.map