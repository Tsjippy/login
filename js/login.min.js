(()=>{"use strict";function e(e){document.querySelectorAll("#message").forEach((t=>t.innerHTML=DOMPurify.sanitize(e)))}let t,n=5;async function o(){n++;let o=new FormData,i=document.getElementById("qrcode-wrapper"),r=document.getElementById("login-qr-code");if(6==n){console.log("Refreshing QR code"),n=0,null!=r&&(o.append("token",r.dataset.token),o.append("key",r.dataset.key));let t=await FormSubmit.fetchRestApi("login/get_login_qr_code",o);t?(i.innerHTML=t,e("Scan the QR code to login"),console.log(`New token: ${document.getElementById("login-qr-code").dataset.token}`),console.log(`New key: ${document.getElementById("login-qr-code").dataset.key}`)):(wrapperinnerHTML="",e("QR Code Refresh Failed"))}else{if(console.log("Checking for login permission"),null==r)return;o.append("token",r.dataset.token),o.append("key",r.dataset.key),o.append("old-token",r.dataset.oldtoken);let n=await FormSubmit.fetchRestApi("login/qr_code_scanned",o);n&&function(n){clearInterval(t),e("Succesfully logged in, redirecting..."),Main.showLoader(document.getElementById("qrcode-wrapper")),n.startsWith("http")?location.href=n:location.reload()}(n)}}function i(){return r.stubThis(void 0!==globalThis?.PublicKeyCredential&&"function"==typeof globalThis.PublicKeyCredential)}const r={stubThis:e=>e};class s extends Error{constructor({message:e,code:t,cause:n,name:o}){super(e,{cause:n}),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=o??n.name,this.code=t}}const a=new class{constructor(){Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}createNewAbortSignal(){if(this.controller){const e=new Error("Cancelling existing WebAuthn API call for new one");e.name="AbortError",this.controller.abort(e)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}};function l(e){const t=new Uint8Array(e);let n="";for(const e of t)n+=String.fromCharCode(e);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function d(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=(4-t.length%4)%4,o=t.padEnd(t.length+n,"="),i=atob(o),r=new ArrayBuffer(i.length),s=new Uint8Array(r);for(let e=0;e<i.length;e++)s[e]=i.charCodeAt(e);return r}const c=e=>e;function u(e){const{id:t}=e;return{...e,id:d(t),transports:e.transports}}const h=["cross-platform","platform"];function m(e){if(e&&!(h.indexOf(e)<0))return e}async function g(t){try{let n=new FormData;n.append("username",t);const o=await FormSubmit.fetchRestApi("login/auth_start",n);if(!o)throw new Error("Fetching Server Challenge failed");null!=sim.login&&sim.login.loadingScreen("Verifying credentials...");const r=await async function(e){!e.optionsJSON&&e.challenge&&(console.warn("startAuthentication() was not called correctly. It will try to continue with the provided options, but this call should be refactored to use the expected call structure instead. See https://simplewebauthn.dev/docs/packages/browser#typeerror-cannot-read-properties-of-undefined-reading-challenge for more information."),e={optionsJSON:e});const{optionsJSON:t,useBrowserAutofill:n=!1,verifyBrowserAutofillInput:o=!0}=e;if(!i())throw new Error("WebAuthn is not supported in this browser");let r;0!==t.allowCredentials?.length&&(r=t.allowCredentials?.map(u));const h={...t,challenge:d(t.challenge),allowCredentials:r},g={};if(n){if(!await function(){if(!i())return c(new Promise((e=>e(!1))));const e=globalThis.PublicKeyCredential;return c(void 0===e?.isConditionalMediationAvailable?new Promise((e=>e(!1))):e.isConditionalMediationAvailable())}())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete$='webauthn']").length<1&&o)throw Error('No <input> with "webauthn" as the only or last value in its `autocomplete` attribute was detected');g.mediation="conditional",h.allowCredentials=[]}let w;g.publicKey=h,g.signal=a.createNewAbortSignal();try{w=await navigator.credentials.get(g)}catch(e){throw function({error:e,options:t}){const{publicKey:n}=t;if(!n)throw Error("options was missing required publicKey property");if("AbortError"===e.name){if(t.signal instanceof AbortSignal)return new s({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else{if("NotAllowedError"===e.name)return new s({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if("SecurityError"===e.name){const t=globalThis.location.hostname;if("localhost"!==(o=t)&&!/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(o))return new s({message:`${globalThis.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e});if(n.rpId!==t)return new s({message:`The RP ID "${n.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else if("UnknownError"===e.name)return new s({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}var o;return e}({error:e,options:g})}if(!w)throw new Error("Authentication was not completed");const{id:p,rawId:f,response:y,type:b}=w;let S;return y.userHandle&&(S=l(y.userHandle)),{id:p,rawId:l(f),response:{authenticatorData:l(y.authenticatorData),clientDataJSON:l(y.clientDataJSON),signature:l(y.signature),userHandle:S},type:b,clientExtensionResults:w.getClientExtensionResults(),authenticatorAttachment:m(w.authenticatorAttachment)}}({...o,useBrowserAutofill:!0});let h=document.getElementById("loginform")?document.getElementById("loginform"):void 0;n=new FormData(h),n.append("publicKeyCredential",btoa(JSON.stringify(r)));let g=await FormSubmit.fetchRestApi("login/auth_finish",n);if(!g||g.verified)throw new Error("Verification failed");return e("Verification successfull"),!0}catch(t){return console.error("Authentication failed:",t),e(t),!1}}window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e||console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.")}));let w=async t=>{if(window.PublicKeyCredential&&PublicKeyCredential.isConditionalMediationAvailable){if(console.log("Conditional UI is understood by the browser"),!await window.PublicKeyCredential.isConditionalMediationAvailable())return void console.log("Conditional UI is understood by your browser but not available")}else{if(!navigator.credentials.conditionalMediationSupported)return void console.log("Your browser does not implement Conditional UI (are you running the right chrome/safari version with the right flags?)");console.log("This browser understand the old version of Conditional UI feature detection")}return sim.login.loadingScreen("Performing passkey login"),await g("")?(e("Passkey login succesfull"),await sim.login.requestLogin()):(sim.login.reset(),e("Passkey login failed, try using your username and password"),!1)};async function p(){let e=!1;return window.PublicKeyCredential?await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()?e=!0:console.log("WebAuthn supported, Platform Authenticator not supported."):console.log("Not supported."),e}console.log("Login.js loaded");const f=class{constructor(){this.init(),null!=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)}).showlogin&&(console.log("Trying silent login"),w()),this.checkIsIOS&&this.addMaximumScaleToMetaViewport(),this.eventListeners()}eventListeners(){document.addEventListener("keypress",(e=>{"Enter"===e.key&&null!=this.creds&&(e.stopImmediatePropagation(),this.curScreen==this.creds&&0==document.getElementById("check-cred").disabled?this.verifyCreds():this.curScreen!=this.email&&this.curScreen!=this.twofa||this.requestLogin())})),document.addEventListener("click",(async n=>{let i=n.target;if(i.matches(".login"))this.openLoginModal(),console.log("Trying silent login");else if("check-cred"==i.id)this.verifyCreds();else if("login-button"==i.id)this.requestLogin();else if(null!=i.closest(".toggle-pwd-view"))!function(e){e.stopImmediatePropagation();var t=e.target;"IMG"==e.target.tagName&&(t=e.target.parentNode),"0"==t.dataset.toggle?(t.title="Hide password",t.dataset.toggle="1",t.innerHTML=t.innerHTML.replace("invisible","visible"),t.closest(".password").querySelector('input[type="password"]').type="text"):(t.title="Show password",t.dataset.toggle="0",t.innerHTML=t.innerHTML.replace("visible","invisible"),t.closest(".password").querySelector('input[type="text"]').type="password")}(n);else if("password-reset-form"==i.id||"lost-pwd-link"==i.id)this.resetPassword(i);else if("retry_webauthn"==i.id)this.showMessage(""),this.verifyWebauthn([]);else if("request_account"==i.name)this.requestAccount(i);else if(null!=i.closest("[name='fingerprintpicture']"))w();else if(i.matches(".show-login-qr"))document.getElementById("usercred-wrapper").classList.add("hidden"),e("Fetching QR code..."),Main.showLoader(document.getElementById("qrcode-wrapper").firstChild),o(),t=setInterval(o,5e3);else{if(!i.matches(".close-qr"))return;clearInterval(t),e(""),document.getElementById("usercred-wrapper").classList.remove("hidden"),document.getElementById("qrcode-wrapper").innerHTML=""}n.stopImmediatePropagation()}))}checkIsIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}init(){this.form=document.getElementById("loginform"),this.msgScreen=document.getElementById("message-wrapper"),this.creds=document.getElementById("credentials-wrapper"),this.twofa=document.getElementById("authenticator-wrapper"),this.email=document.getElementById("email-wrapper"),this.login=document.getElementById("login-button-wrapper"),this.passwordReset=document.getElementById("password-reset-form"),this.curScreen=this.creds,null==this.msgScreen.querySelector(".loader")&&Main.showLoader(this.msgScreen.querySelector(".status-message"),!1,75)}resetForm(){this.reset(),this.showScreen(this.creds),this.curScreen=this.creds}loadingScreen(e){this.msgScreen.querySelector(".status-message").textContent=e,this.curScreen.classList.add("hidden"),this.login.classList.add("hidden"),this.passwordReset.classList.add("hidden"),this.msgScreen.classList.remove("hidden")}reset(){null!=this.curScreen&&(this.curScreen.classList.remove("hidden"),this.msgScreen.classList.add("hidden"),this.passwordReset.classList.remove("hidden"))}showScreen(t){null!=this.curScreen&&(this.curScreen.classList.add("hidden"),this.msgScreen.classList.add("hidden")),t.classList.remove("hidden"),t==this.twofa||t==this.email?this.login.classList.remove("hidden"):this.login.classList.add("hidden"),t.querySelectorAll("input").forEach((e=>window.setTimeout((()=>e.focus()),0))),this.curScreen=t,e("")}async verifyCreds(){this.username=document.getElementById("username").value;let t=document.getElementById("password").value;if(""==this.username||""==t)return void e("Please give an username and password!");this.passwordReset.classList.add("hidden"),this.loadingScreen("Verifying Credentials"),await Main.waitForInternet();let n=new FormData(this.form),o=await FormSubmit.fetchRestApi("login/check-cred",n);o?(o=!(!o||0==o)&&this.addMethods(o),o||(this.reset(),e("Invalid login, try again"))):this.reset()}addMethods(t){return"object"!=typeof t&&location.reload(),"redirect"in t?(location.href=t.redirect,!0):t instanceof Array?(t.find((e=>"webauthn"==e))?p()?this.verifyWebauthn(t):1==t.length?(e("You do not have a valid second login method for this device, please add one."),this.requestLogin()):this.showTwoFaFields(t):this.showTwoFaFields(t),!0):void 0}async verifyWebauthn(t){this.loadingScreen("Starting Webauthentication");try{if(!await g(this.username,this.msgScreen.querySelector(".status-message")))throw new Error("Webauthentication failed");await this.requestLogin()}catch(n){if(1==t.length)e("Authentication failed, please setup an additional login factor."),this.requestLogin();else{let o;console.error(n),o="No authenticator available"==n.message?"No biometric login for this device found. <br>Give verification code.":"Web authentication failed, please give verification code.",e(o),this.showTwoFaFields(t)}}}async requestLogin(){this.loadingScreen("Logging in...");let e=new FormData(this.form);if(this.form.querySelectorAll(".hidden [required]").forEach((e=>{e.required=!1})),!this.form.reportValidity())return this.reset(),!1;await Main.waitForInternet();let t=await FormSubmit.fetchRestApi("login/request_login",e);return t?(window.self!==window.top?(console.log(window.parent.document.getElementById("iframe-loader")),console.log(window.parent.document),console.log(window.parent),window.parent.document.getElementById("iframe-loader").textContent="Succesfully logged in, you may now close this popup",window.parent.sim.restNonce=t.nonce,window.parent.sim.userId=t.id,console.log(window.parent.document.getElementById("iframe-loader")),window.parent.document.querySelectorAll("iframe").forEach((e=>e.remove()))):(this.loadingScreen("Succesfully logged in, redirecting..."),""==t.redirect?location.reload():location.href=t.redirect),!0):(this.reset(),!1)}showTwoFaFields(e){e.includes("email")&&this.requestEmailCode();for(const t of e)"webauthn"!=t&&("email"==t?this.showScreen(this.email):this.showScreen(this.twofa))}async requestEmailCode(){this.showScreen(this.email),e(`Sending e-mail... ${Main.showLoader(null,!1,20,"",!0)}`);let t=new FormData;t.append("username",this.username),e(await FormSubmit.fetchRestApi("login/request_email_code",t,!1)||"Sending e-mail failed")}async resetPassword(e){let t=e.closest("form"),n=t.querySelector("#lost-pwd-link"),o=t.querySelector("div.form-elements");if(null!=o&&""!=o.innerHTML&&o.classList.contains("hidden"))return document.getElementById("loginform").classList.add("hidden"),null==t.querySelector("[name='username']")&&(o.innerHTML=`<label class="form-label">\n\t\t\t\t\tUsername<br>\n\t\t\t\t\t<input type="text" name="username" id="username" class="form-control" value="${this.username}" required>\n\t\t\t\t</label><br>`+o.innerHTML),o.classList.remove("hidden"),n.dataset.orghtml=n.innerHTML,n.innerHTML="Request Password Reset",void n.classList.add("button");if(""==this.username)return void Main.displayMessage("Specify your username first","error");n.classList.add("hidden");let i=Main.showLoader(n,!1,50,"Requesting Password Reset...   "),r=new FormData(t);r.append("username",this.username);let s=await FormSubmit.fetchRestApi("login/request_pwd_reset",r);s&&(Main.displayMessage(s,"success"),document.getElementById("loginform").classList.remove("hidden"),o.classList.add("hidden"),n.innerHTML=n.dataset.orghtml,n.classList.remove("button")),i.remove(),n.classList.remove("hidden")}async requestAccount(e){let t=e.closest("form");t.querySelector(".loader-wrapper").classList.remove("hidden");let n=new FormData(t),o=await FormSubmit.fetchRestApi("login/request_user_account",n);o&&Main.displayMessage(o),t.reset(),t.querySelector(".loader-wrapper").classList.add("hidden")}openLoginModal(){document.querySelectorAll("#site-navigation, #mobile-menu-control-wrapper").forEach((e=>e.classList.remove("toggled"))),document.querySelector("body").classList.remove("mobile-menu-open"),document.querySelectorAll("#mobile-menu-control-wrapper > button").forEach((e=>e.ariaExpanded=0)),document.querySelector("body").style.overflowY="hidden",this.modal=document.getElementById("login-modal"),this.modal.style.display="block",this.modal.classList.remove("hidden"),this.resetForm()}addMaximumScaleToMetaViewport(){let e=document.querySelector("meta[name=viewport]");if(null!==e){let t=e.getAttribute("content"),n=/maximum\-scale=[0-9\.]+/g;t=n.test(t)?t.replace(n,"maximum-scale=1.0"):[t,"maximum-scale=1.0"].join(", "),e.setAttribute("content",t)}}};document.addEventListener("DOMContentLoaded",(()=>{p(),document.querySelectorAll(".login.hidden").forEach((e=>{e.classList.remove("hidden")})),sim.login=new f}))})();
//# sourceMappingURL=login.min.js.map