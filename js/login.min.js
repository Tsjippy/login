(()=>{"use strict";const e=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},t=e=>btoa(String.fromCharCode(...e)),n=t=>(t.challenge=Uint8Array.from(e(t.challenge),(e=>e.charCodeAt(0))),void 0!==t.user&&(t.user={...t.user,id:Uint8Array.from(window.atob(t.user.id),(e=>e.charCodeAt(0)))}),void 0!==t.excludeCredentials&&(t.excludeCredentials=t.excludeCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),void 0!==t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map((t=>({...t,id:Uint8Array.from(e(t.id),(e=>e.charCodeAt(0)))})))),t),i=e=>{const n={id:e.id,type:e.type,rawId:t(new Uint8Array(e.rawId)),response:{clientDataJSON:t(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(n.response.attestationObject=t(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(n.response.authenticatorData=t(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(n.response.signature=t(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(n.response.userHandle=t(new Uint8Array(e.response.userHandle))),n};function o(e){document.querySelector("#message").innerHTML=DOMPurify.sanitize(e)}let r,s=5;async function a(){s++;let e=new FormData,t=document.getElementById("qrcode-wrapper"),n=document.getElementById("login-qr-code");if(6==s){console.log("Refreshing QR code"),s=0,null!=n&&(e.append("token",n.dataset.token),e.append("key",n.dataset.key));let i=await FormSubmit.fetchRestApi("login/get_login_qr_code",e);i?(t.innerHTML=i,o("Scan the QR code to login"),console.log(`New token: ${document.getElementById("login-qr-code").dataset.token}`),console.log(`New key: ${document.getElementById("login-qr-code").dataset.key}`)):(wrapperinnerHTML="",o("QR Code Refresh Failed"))}else{if(console.log("Checking for login permission"),null==n)return;e.append("token",n.dataset.token),e.append("key",n.dataset.key),e.append("old-token",n.dataset.oldtoken);let t=await FormSubmit.fetchRestApi("login/qr_code_scanned",e);t&&function(e){clearInterval(r),o("Succesfully logged in, redirecting..."),Main.showLoader(document.getElementById("qrcode-wrapper")),e.startsWith("http")?location.href=e:location.reload()}(t)}}let l,d=!1;null!=window.PublicKeyCredential&&window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e||console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.")}));let c=async e=>{if(window.PublicKeyCredential&&PublicKeyCredential.isConditionalMediationAvailable){if(console.log("Conditional UI is understood by the browser"),!await window.PublicKeyCredential.isConditionalMediationAvailable())return void console.log("Conditional UI is understood by your browser but not available")}else{if(!navigator.credentials.conditionalMediationSupported)return void console.log("Your browser does not implement Conditional UI (are you running the right chrome/safari version with the right flags?)");console.log("This browser understand the old version of Conditional UI feature detection")}null!=l&&(console.log("Cancelling previous request"),l.abort("aborted")),l=new AbortController,l.onAbort=function(e){console.log(e)},l.signal.onAbort=function(e){console.log(e)},"conditional"!=e&&sim.login.loadingScreen("Performing passkey login");try{let t=new FormData;t.append("username","");let r=await FormSubmit.fetchRestApi("login/auth_start",t);if(!r)throw new Error("auth_start failed");let s=n(r),a=await navigator.credentials.get({signal:l.signal,publicKey:{challenge:s.challenge},mediation:e});return"conditional"==e&&sim.login.loadingScreen("Performing passkey login"),await async function(e){if(!d){if(e){d=!0,sim.login.loadingScreen("Verifying credentials...");const t=i(e);let n=new FormData(document.getElementById("loginform"));return n.append("publicKeyCredential",JSON.stringify(t)),await FormSubmit.fetchRestApi("login/auth_finish",n,!1)?(o("Passkey login succesfull"),await sim.login.requestLogin()):(sim.login.reset(),o("Passkey login failed, try using your username and password"),!1)}return console.log("Credential returned null"),sim.login.resetForm(),o("Passkey login failed"),!1}}(a)}catch(t){return"aborted"==t?(console.log("request aborted"),!1):(t.message.includes("A request is already pending.")&&c(e),null!=sim.login&&(sim.login.resetForm(),o("Passkey login failed, try using your username and password")),console.log(t),!1)}};async function u(){let e=!1;return window.PublicKeyCredential?await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()?e=!0:console.log("WebAuthn supported, Platform Authenticator not supported."):console.log("Not supported."),e}console.log("Login.js loaded");const m=class{constructor(){this.init(),null!=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)}).showlogin&&(console.log("Trying silent login"),c("silent")),this.checkIsIOS&&this.addMaximumScaleToMetaViewport(),this.eventListeners()}eventListeners(){document.addEventListener("keypress",(e=>{"Enter"===e.key&&null!=this.creds&&(e.stopImmediatePropagation(),this.curScreen==this.creds&&0==document.getElementById("check-cred").disabled?this.verifyCreds():this.curScreen!=this.email&&this.curScreen!=this.twofa||this.requestLogin())})),document.addEventListener("click",(async e=>{let t=e.target;if(t.matches(".login"))this.openLoginModal(),console.log("Trying silent login");else if("check-cred"==t.id)this.verifyCreds();else if("login-button"==t.id)this.requestLogin();else if(null!=t.closest(".toggle-pwd-view"))!function(e){e.stopImmediatePropagation();var t=e.target;"IMG"==e.target.tagName&&(t=e.target.parentNode),"0"==t.dataset.toggle?(t.title="Hide password",t.dataset.toggle="1",t.innerHTML=t.innerHTML.replace("invisible","visible"),t.closest(".password").querySelector('input[type="password"]').type="text"):(t.title="Show password",t.dataset.toggle="0",t.innerHTML=t.innerHTML.replace("visible","invisible"),t.closest(".password").querySelector('input[type="text"]').type="password")}(e);else if("password-reset-form"==t.id||"lost-pwd-link"==t.id)this.resetPassword(t);else if("retry_webauthn"==t.id)this.showMessage(""),this.verifyWebauthn([]);else if("request_account"==t.name)this.requestAccount(t);else if(null!=t.closest("[name='fingerprintpicture']"))c("silent");else if(t.matches(".show-login-qr"))document.getElementById("usercred-wrapper").classList.add("hidden"),o("Fetching QR code..."),Main.showLoader(document.getElementById("qrcode-wrapper").firstChild),a(),r=setInterval(a,5e3);else{if(!t.matches(".close-qr"))return;clearInterval(r),o(""),document.getElementById("usercred-wrapper").classList.remove("hidden"),document.getElementById("qrcode-wrapper").innerHTML=""}e.stopImmediatePropagation()}))}checkIsIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}init(){this.form=document.getElementById("loginform"),this.msgScreen=document.getElementById("message-wrapper"),this.creds=document.getElementById("credentials-wrapper"),this.twofa=document.getElementById("authenticator-wrapper"),this.email=document.getElementById("email-wrapper"),this.login=document.getElementById("login-button-wrapper"),this.passwordReset=document.getElementById("password-reset-form"),this.curScreen=this.creds,null==this.msgScreen.querySelector(".loader")&&Main.showLoader(this.msgScreen.querySelector(".status-message"),!1,75)}resetForm(){this.reset(),this.showScreen(this.creds),this.curScreen=this.creds}loadingScreen(e){this.msgScreen.querySelector(".status-message").textContent=e,this.curScreen.classList.add("hidden"),this.login.classList.add("hidden"),this.passwordReset.classList.add("hidden"),this.msgScreen.classList.remove("hidden")}reset(){null!=this.curScreen&&(this.curScreen.classList.remove("hidden"),this.msgScreen.classList.add("hidden"),this.passwordReset.classList.remove("hidden"))}showScreen(e){null!=this.curScreen&&(this.curScreen.classList.add("hidden"),this.msgScreen.classList.add("hidden")),e.classList.remove("hidden"),e==this.twofa||e==this.email?this.login.classList.remove("hidden"):this.login.classList.add("hidden"),e.querySelectorAll("input").forEach((e=>window.setTimeout((()=>e.focus()),0))),this.curScreen=e,o("")}async verifyCreds(){this.username=document.getElementById("username").value;let e=document.getElementById("password").value;if(""==this.username||""==e)return void o("Please give an username and password!");this.passwordReset.classList.add("hidden"),this.loadingScreen("Verifying Credentials"),await Main.waitForInternet();let t=new FormData(this.form),n=await FormSubmit.fetchRestApi("login/check-cred",t);n?(n=!(!n||0==n)&&this.addMethods(n),n||(this.reset(),o("Invalid login, try again"))):this.reset()}addMethods(e){return"object"!=typeof e&&location.reload(),"redirect"in e?(location.href=e.redirect,!0):e instanceof Array?(e.find((e=>"webauthn"==e))?u()?this.verifyWebauthn(e):1==e.length?(o("You do not have a valid second login method for this device, please add one."),this.requestLogin()):this.showTwoFaFields(e):this.showTwoFaFields(e),!0):void 0}async verifyWebauthn(e){this.loadingScreen("Starting Webauthentication");try{if(!await async function(e,t=null){null!=t&&(t.classList.remove("success"),t.classList.remove("error"));try{let o=new FormData;o.append("username",e);let r=await FormSubmit.fetchRestApi("login/auth_start",o);if(!r)throw new Error("Fetching Server Challenge failed");let s=n(r);null!=t&&(t.textContent="Waiting for biometric");let a=await navigator.credentials.get({publicKey:s});null!=t&&(t.textContent="Verifying...");const l=i(a);let d=document.getElementById("loginform")?document.getElementById("loginform"):void 0;if(o=new FormData(d),o.append("publicKeyCredential",JSON.stringify(l)),r=await FormSubmit.fetchRestApi("login/auth_finish",o),!r)throw new Error("Verification failed");return null!=t?t.textContent="Verification successfull":Main.displayMessage("Verification successfull"),!0}catch(e){return console.error(e),null!=t?t.textContent=e:Main.displayMessage(e,"error"),!1}}(this.username,this.msgScreen.querySelector(".status-message")))throw new Error("Webauthentication failed");await this.requestLogin()}catch(t){let n=await FormSubmit.fetchRestApi("login/mark_bio_as_failed","",!1);if(console.log(n),1==e.length)o("Authentication failed, please setup an additional login factor."),this.requestLogin();else{let n;console.error(t),n="No authenticator available"==t.message?"No biometric login for this device found. <br>Give verification code.":"Web authentication failed, please give verification code.",o(n),this.showTwoFaFields(e)}}}async requestLogin(){this.loadingScreen("Logging in...");let e=new FormData(this.form);if(this.form.querySelectorAll(".hidden [required]").forEach((e=>{e.required=!1})),!this.form.reportValidity())return this.reset(),!1;await Main.waitForInternet();let t=await FormSubmit.fetchRestApi("login/request_login",e);return t?(window.self!==window.top?(console.log(window.parent.document.getElementById("iframe-loader")),console.log(window.parent.document),console.log(window.parent),window.parent.document.getElementById("iframe-loader").textContent="Succesfully logged in, you may now close this popup",window.parent.sim.restNonce=t.nonce,window.parent.sim.userId=t.id,console.log(window.parent.document.getElementById("iframe-loader")),window.parent.document.querySelectorAll("iframe").forEach((e=>e.remove()))):(this.loadingScreen("Succesfully logged in, redirecting..."),""==t.redirect?location.reload():location.href=t.redirect),!0):(this.reset(),!1)}showTwoFaFields(e){e.includes("email")&&this.requestEmailCode();for(const t of e)"webauthn"!=t&&("email"==t?this.showScreen(this.email):this.showScreen(this.twofa))}async requestEmailCode(){this.showScreen(this.email),o(`Sending e-mail... ${Main.showLoader(null,!1,20,"",!0)}`);let e=new FormData;e.append("username",this.username),o(await FormSubmit.fetchRestApi("login/request_email_code",e,!1)||"Sending e-mail failed")}async resetPassword(e){let t=e.closest("form"),n=t.querySelector("#lost-pwd-link"),i=t.querySelector("div.form-elements");if(null!=i&&""!=i.innerHTML&&i.classList.contains("hidden"))return document.getElementById("loginform").classList.add("hidden"),null==t.querySelector("[name='username']")&&(i.innerHTML=`<label class="form-label">\n\t\t\t\t\tUsername<br>\n\t\t\t\t\t<input type="text" name="username" id="username" class="form-control" value="${this.username}" required>\n\t\t\t\t</label><br>`+i.innerHTML),i.classList.remove("hidden"),n.dataset.orghtml=n.innerHTML,n.innerHTML="Request Password Reset",void n.classList.add("button");if(""==this.username)return void Main.displayMessage("Specify your username first","error");n.classList.add("hidden");let o=Main.showLoader(n,!1,50,"Requesting Password Reset...   "),r=new FormData(t);r.append("username",this.username);let s=await FormSubmit.fetchRestApi("login/request_pwd_reset",r);s&&(Main.displayMessage(s,"success"),document.getElementById("loginform").classList.remove("hidden"),i.classList.add("hidden"),n.innerHTML=n.dataset.orghtml,n.classList.remove("button")),o.remove(),n.classList.remove("hidden")}async requestAccount(e){let t=e.closest("form");t.querySelector(".loader-wrapper").classList.remove("hidden");let n=new FormData(t),i=await FormSubmit.fetchRestApi("login/request_user_account",n);i&&Main.displayMessage(i),t.reset(),t.querySelector(".loader-wrapper").classList.add("hidden")}openLoginModal(){document.querySelectorAll("#site-navigation, #mobile-menu-control-wrapper").forEach((e=>e.classList.remove("toggled"))),document.querySelector("body").classList.remove("mobile-menu-open"),document.querySelectorAll("#mobile-menu-control-wrapper > button").forEach((e=>e.ariaExpanded=0)),document.querySelector("body").style.overflowY="hidden",this.modal=document.getElementById("login-modal"),this.modal.style.display="block",this.modal.classList.remove("hidden"),this.resetForm()}addMaximumScaleToMetaViewport(){let e=document.querySelector("meta[name=viewport]");if(null!==e){let t=e.getAttribute("content"),n=/maximum\-scale=[0-9\.]+/g;t=n.test(t)?t.replace(n,"maximum-scale=1.0"):[t,"maximum-scale=1.0"].join(", "),e.setAttribute("content",t)}}};document.addEventListener("DOMContentLoaded",(()=>{u(),document.querySelectorAll(".login.hidden").forEach((e=>{e.classList.remove("hidden")})),sim.login=new m}))})();
//# sourceMappingURL=login.min.js.map