(()=>{"use strict";function e(){return t.stubThis(void 0!==globalThis?.PublicKeyCredential&&"function"==typeof globalThis.PublicKeyCredential)}const t={stubThis:e=>e};class n extends Error{constructor({message:e,code:t,cause:n,name:o}){super(e,{cause:n}),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=o??n.name,this.code=t}}const o=new class{constructor(){Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}createNewAbortSignal(){if(this.controller){const e=new Error("Cancelling existing WebAuthn API call for new one");e.name="AbortError",this.controller.abort(e)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}};function r(e){const t=new Uint8Array(e);let n="";for(const e of t)n+=String.fromCharCode(e);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function i(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=(4-t.length%4)%4,o=t.padEnd(t.length+n,"="),r=atob(o),i=new ArrayBuffer(r.length),a=new Uint8Array(i);for(let e=0;e<r.length;e++)a[e]=r.charCodeAt(e);return i}const a=e=>e;function s(e){const{id:t}=e;return{...e,id:i(t),transports:e.transports}}const l=["cross-platform","platform"];function c(e){if(e&&!(l.indexOf(e)<0))return e}function u(e){document.querySelectorAll("#message").forEach(t=>t.innerHTML=DOMPurify.sanitize(e))}async function d(t,l=!1){try{let d=new FormData;l||d.append("username",t);const h=await FormSubmit.fetchRestApi("login/auth_start",d);if(!h)throw new Error("Fetching Server Challenge failed");null==sim.login||l||sim.login.loadingScreen("Preparing Passkey Verification...");let f={optionsJSON:h};l&&(f.useBrowserAutofill=!0);const g=await async function(t){!t.optionsJSON&&t.challenge&&(console.warn("startAuthentication() was not called correctly. It will try to continue with the provided options, but this call should be refactored to use the expected call structure instead. See https://simplewebauthn.dev/docs/packages/browser#typeerror-cannot-read-properties-of-undefined-reading-challenge for more information."),t={optionsJSON:t});const{optionsJSON:l,useBrowserAutofill:u=!1,verifyBrowserAutofillInput:d=!0}=t;if(!e())throw new Error("WebAuthn is not supported in this browser");let h;0!==l.allowCredentials?.length&&(h=l.allowCredentials?.map(s));const f={...l,challenge:i(l.challenge),allowCredentials:h},g={};if(u){if(!await function(){if(!e())return a(new Promise(e=>e(!1)));const t=globalThis.PublicKeyCredential;return a(void 0===t?.isConditionalMediationAvailable?new Promise(e=>e(!1)):t.isConditionalMediationAvailable())}())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete$='webauthn']").length<1&&d)throw Error('No <input> with "webauthn" as the only or last value in its `autocomplete` attribute was detected');g.mediation="conditional",f.allowCredentials=[]}let m;g.publicKey=f,g.signal=o.createNewAbortSignal();try{m=await navigator.credentials.get(g)}catch(e){throw function({error:e,options:t}){const{publicKey:o}=t;if(!o)throw Error("options was missing required publicKey property");if("AbortError"===e.name){if(t.signal instanceof AbortSignal)return new n({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else{if("NotAllowedError"===e.name)return new n({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if("SecurityError"===e.name){const t=globalThis.location.hostname;if("localhost"!==(r=t)&&!/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(r))return new n({message:`${globalThis.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e});if(o.rpId!==t)return new n({message:`The RP ID "${o.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else if("UnknownError"===e.name)return new n({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}var r;return e}({error:e,options:g})}if(!m)throw new Error("Authentication was not completed");const{id:w,rawId:p,response:b,type:y}=m;let E;return b.userHandle&&(E=r(b.userHandle)),{id:w,rawId:r(p),response:{authenticatorData:r(b.authenticatorData),clientDataJSON:r(b.clientDataJSON),signature:r(b.signature),userHandle:E},type:y,clientExtensionResults:m.getClientExtensionResults(),authenticatorAttachment:c(m.authenticatorAttachment)}}(f);sim.login.loadingScreen("Validating Passkey...");let m=document.getElementById("loginform")?document.getElementById("loginform"):void 0;d=new FormData(m),d.append("publicKeyCredential",btoa(JSON.stringify(g)));let w=await FormSubmit.fetchRestApi("login/auth_finish",d);if(!w||w.verified)throw new Error("Passkey Verification failed");return w?(u("Passkey Verification Succesfull"),await sim.login.requestLogin()):(sim.login.reset(),u("Passkey Verification failed, try using your username and password"),!1)}catch(e){return l&&e instanceof n&&"ERROR_CEREMONY_ABORTED"===e.code||(console.error("Passkey Verification Failed:",e),u(e),document.querySelectorAll(".status-message").forEach(e=>e.innerHTML=DOMPurify.sanitize("Passkey Verification Failed"))),!1}}window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(e=>{e||console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.")}),console.log("Qr code login loaded"),document.addEventListener("DOMContentLoaded",async function(){await d(sim.userId,document.getElementById("message"))&&(document.querySelector("main").innerHTML='You can close this window now.<br><br> You will be redirected to the home page automatically in <span id="countdown">6</span> seconds.',setInterval(function(){let e=document.getElementById("countdown"),t=parseInt(e.textContent);t<1?location.href=sim.baseUrl+"?message=Login%20succesfully%20aproved":(t--,e.textContent=t)},1e3)),document.querySelectorAll(".loader-wrapper").forEach(e=>e.classList.add("hidden"))})})();
//# sourceMappingURL=qr_code_login.min.js.map